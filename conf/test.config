
docker {
    enabled = true
    runOptions = "--platform linux/amd64"
}
executor {
    queueSize = 2         // Limit the total number of concurrent processes
}
process {
    // publishDir = { "${params.outdir}/${params.project}" }
    maxCpus = 1       // Limit to 8 CPUs
    maxMemory = '8 GB' // Limit to 8 GB of memory

    // Impose sensible resource limits for testing

    withName: '.*' {
        cpus   = 1
        memory = 8.GB
        time   = 3.h
    }

}

params {
    // Required parameters
    input    = "$projectDir/assets/samplesheet-test-local.csv"
    outdir   = "$projectDir/test-out"
    project  = "test"
    
    // Test data settings
    singleEnd = false
    mergeReads = false
    annotation = true
    rna = false
    skipHumann = false

    // Minimize data for testing
    nreads = 10000
    minreads = 100   // Very low threshold for testing
    
    // Enable processing for testing new workflow
    process_humann_tables = true
    split_size = 2  // Small split size for testing
    
    // Containers - use the same as main config
    docker_container_humann4 = 'lightweightlabware/humann:4.0.0a1-1'
    docker_container_humann3 = "biobakery/humann:3.9"
    docker_container_metaphlan = "quay.io/biocontainers/metaphlan:4.2.2--pyhdfd78af_0"
    docker_container_fastp = "quay.io/biocontainers/fastp:0.23.4--hadf994f_1"
    docker_container_medi = "lightweightlabware/medi:latest"
    

    // Test database paths
    metaphlan_index = "mpa_vJan21_TOY_CHOCOPhlAnSGB_202103"
    humann_metaphlan_index = "mpa_vJan21_TOY_CHOCOPhlAnSGB_202103"
    metaphlan_db = "$projectDir/assets/test_dbs/mp4_test_db/"
    bt2options = "very-sensitive"
    humann_metaphlan_db = "$projectDir/assets/test_dbs/mp4_test_db/"
    
    chocophlan = "$projectDir/assets/test_dbs/chocophlan_v4"
    uniref = "$projectDir/assets/test_dbs/uniref"
    utility_mapping = "$projectDir/assets/test_dbs/utility_mapping_test"
    
    // Additional command line parameters
    humann_params="--bypass-translated-search"
    
    // MEDI quantification parameters (disabled by default for tests)
    enable_medi = false
    medi_db_path = null
    medi_foods_file = null
    medi_food_contents_file = null
    confidence = 0.3
    consistency = 0.95
    entropy = 0.1
    multiplicity = 4
    mapping = false
    read_length = 150
    threshold = 10
    batchsize = 10  // Smaller batch size for testing
}

// Disable execution reports for tests
timeline.enabled = false
report.enabled = false
trace.enabled = false
dag.enabled = false

// Clean work directory
cleanup = true


